<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Audience Voting</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
  </style>
</head>
<body class="font-sans m-4 max-w-4xl">
  <div class="mb-4">
    <button onclick="window.history.back()" class="px-3 py-2 rounded-lg border border-gray-300 bg-white cursor-pointer">← Back</button>
  </div>
  <h2 class="text-2xl font-bold mb-4">Audience Mode (Customer Jury)</h2>
  <div id="meta"></div>

  <div class="border border-gray-300 rounded-xl p-3 my-3">
    <button onclick="join()" class="px-3 py-2.5 rounded-lg border border-gray-300 bg-white cursor-pointer mt-2.5">Join Audience</button>
  </div>

  <div class="border border-gray-300 rounded-xl p-3 my-3">
    <h3 class="m-0 mb-2">Vote (Active Teams Only)</h3>
    <label class="block mt-1.5">ทีมที่ "แก้ Pain จริง" ( Value)</label>
    <select id="valueTeam" class="w-full px-2.5 py-2.5 rounded-lg border border-gray-300 mt-1.5"></select>

    <label class="block mt-1.5">ทีมที่ "ต่างจริง" ( Differentiation)</label>
    <select id="diffTeam" class="w-full px-2.5 py-2.5 rounded-lg border border-gray-300 mt-1.5"></select>

    <label class="block mt-1.5">ทีมที่ "เหมือนตลาด/แดง" ( Red Ocean)</label>
    <select id="redTeam" class="w-full px-2.5 py-2.5 rounded-lg border border-gray-300 mt-1.5"></select>

    <button onclick="vote()" class="px-3 py-2.5 rounded-lg border border-gray-300 bg-white cursor-pointer mt-2.5">Submit Vote</button>
    <div id="hint" class="mt-2 text-gray-600"></div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let STATE = null;

    socket.on("state", (s) => {
      STATE = s;
      document.getElementById("meta").innerHTML =
        `<span class="inline-block px-2.5 py-1 rounded-full bg-gray-100 mr-1.5">Round: ${s.currentRound}</span>
         <span class="inline-block px-2.5 py-1 rounded-full bg-gray-100 mr-1.5">Active: ${s.activeTeams.join(", ")}</span>
         <span class="inline-block px-2.5 py-1 rounded-full bg-gray-100 mr-1.5">Phase: ${s.phase}</span>
         <span class="inline-block px-2.5 py-1 rounded-full bg-gray-100 mr-1.5">Event: ${s.eventText || "-"}</span>`;
      renderOptions();
    });

    socket.on("joinedAudience", () => {
      document.getElementById("hint").textContent = "Joined ✅ โหวตได้แล้ว";
    });

    function join(){ socket.emit("joinAudience"); }

    function renderOptions(){
      if (!STATE) return;
      const active = new Set(STATE.activeTeams);
      const teams = STATE.teams.filter(t=>active.has(t.id));
      const opts = teams.map(t => `<option value="${t.id}">${t.name} (#${t.id})</option>`).join("");
      document.getElementById("valueTeam").innerHTML = opts;
      document.getElementById("diffTeam").innerHTML = opts;
      document.getElementById("redTeam").innerHTML = opts;
    }

    function vote(){
      socket.emit("vote", {
        valueTeam: Number(document.getElementById("valueTeam").value),
        diffTeam: Number(document.getElementById("diffTeam").value),
        redOceanTeam: Number(document.getElementById("redTeam").value),
      });
      document.getElementById("hint").textContent = "โหวตแล้ว ✅ คะแนนจะขึ้นบนจอ";
    }
  </script>
</body>
</html>
