<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Facilitator Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      .event {
        background: #fff7e6;
        border: 1px solid #ffd27d;
      }
    </style>
  </head>
  <body class="font-sans m-4">
    <div class="text-xl font-bold">Idea-to-Market: Create Your Blue Ocean ‚Äî Facilitator</div>
    <div id="meta"></div>

    <div class="flex gap-4 items-start flex-wrap">
      <div class="border border-gray-300 rounded-xl p-3 min-w-[260px]">
        <h3 class="m-0 mb-2">Controls</h3>
        <div>
          <button onclick="setPhase('A')" class="px-2.5 py-2 rounded-lg border border-gray-300 bg-white cursor-pointer m-1">Phase A</button>
          <button onclick="setPhase('B')" class="px-2.5 py-2 rounded-lg border border-gray-300 bg-white cursor-pointer m-1">Phase B</button>
          <button onclick="setPhase('C')" class="px-2.5 py-2 rounded-lg border border-gray-300 bg-white cursor-pointer m-1">Phase C</button>
          <button onclick="setPhase('D')" class="px-2.5 py-2 rounded-lg border border-gray-300 bg-white cursor-pointer m-1">Phase D</button>
          <button onclick="setPhase('END')" class="px-2.5 py-2 rounded-lg border border-gray-300 bg-white cursor-pointer m-1">END</button>
        </div>
        <div class="mt-2">
          <button onclick="backRound()" class="px-2.5 py-2 rounded-lg border border-gray-300 bg-white cursor-pointer m-1">‚û°Ô∏è Back Round</button>
          <button onclick="draw('customer')" class="px-2.5 py-2 rounded-lg border border-gray-300 bg-white cursor-pointer m-1">üé¥ Random Customer/Pain</button>
          <button onclick="draw('event')" class="px-2.5 py-2 rounded-lg border border-gray-300 bg-white cursor-pointer m-1">‚ö° Draw Event</button>
          <button onclick="nextRound()" class="px-2.5 py-2 rounded-lg border border-gray-300 bg-white cursor-pointer m-1">‚û°Ô∏è Next Round</button>
          <button onclick="resetGame()" class="px-2.5 py-2 rounded-lg border border-red-300 bg-red-50 cursor-pointer m-1">üîÑ Reset All</button>
        </div>
      </div>

      <div class="border border-orange-300 rounded-xl p-3 min-w-[260px] bg-orange-50">
        <h3 class="m-0 mb-2">Event</h3>
        <div id="eventText">‚Äî</div>
      </div>

      <div class="border border-gray-300 rounded-xl p-3 min-w-[260px]">
        <h3 class="m-0 mb-2">Quick Score Adjust</h3>
        <div>
          Team ID
          <input id="tid" type="number" min="1" max="12" class="w-15 px-2.5 py-2.5 rounded-lg border border-gray-300 mt-1.5" />
          ‚ù§Ô∏è <input id="dv" type="number" value="0" class="w-15 px-2.5 py-2.5 rounded-lg border border-gray-300 mt-1.5" /> ‚öîÔ∏è
          <input id="dc" type="number" value="0" class="w-15 px-2.5 py-2.5 rounded-lg border border-gray-300 mt-1.5" /> üí°
          <input id="dd" type="number" value="0" class="w-15 px-2.5 py-2.5 rounded-lg border border-gray-300 mt-1.5" />
          <button onclick="adjust()" class="px-2.5 py-2 rounded-lg border border-gray-300 bg-white cursor-pointer m-1">Apply</button>
        </div>
        <small class="text-xs text-gray-600">‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÇ‡∏ö‡∏ô‡∏±‡∏™/‡∏´‡∏±‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡πá‡∏ß ‡πÜ</small>
      </div>
    </div>

    <div class="border border-gray-300 rounded-xl p-3 mt-4">
      <h3 class="m-0 mb-2">Scoreboard (Active Teams)</h3>
      <div id="board"></div>
    </div>

    <div class="border border-gray-300 rounded-xl p-3 mt-4">
      <h3 class="m-0 mb-2">Live Submissions (Active Teams)</h3>
      <div id="subs"></div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      let STATE = null;

      socket.on("state", (s) => {
        STATE = s;
        document.getElementById("meta").innerHTML =
          `<span class="inline-block px-2.5 py-1 rounded-full bg-gray-100 mr-1.5">GameCode: ${s.gameCode}</span>
         <span class="inline-block px-2.5 py-1 rounded-full bg-gray-100 mr-1.5">Round: ${s.currentRound}</span>
         <span class="inline-block px-2.5 py-1 rounded-full bg-gray-100 mr-1.5">Active: ${s.activeTeams.join(", ")}</span>
         <span class="inline-block px-2.5 py-1 rounded-full bg-gray-100 mr-1.5">Phase: ${s.phase}</span>`;
        document.getElementById("eventText").textContent = s.eventText || "‚Äî";
        renderBoard();
        renderSubs();
      });

      function setPhase(phase) {
        socket.emit("facilitator:setPhase", { phase });
      }
      function nextRound() {
        socket.emit("facilitator:nextRound");
      }
      function backRound() {
        socket.emit("facilitator:backRound");
      }
      function draw(type) {
        socket.emit("facilitator:drawRandom", { type });
      }
      function resetGame() {
        if (confirm("Are you sure you want to reset the entire game? This will clear all data.")) {
          socket.emit("facilitator:resetGame");
        }
      }
      function adjust() {
        socket.emit("facilitator:adjustScore", {
          teamId: Number(document.getElementById("tid").value),
          deltaValue: Number(document.getElementById("dv").value),
          deltaComp: Number(document.getElementById("dc").value),
          deltaDiff: Number(document.getElementById("dd").value),
        });
      }

      function renderBoard() {
        const active = new Set(STATE.activeTeams);
        const rows = STATE.teams
          .filter((t) => active.has(t.id))
          .map(
            (t) => `
        <tr>
          <td><b>${t.name}</b><br/>#${t.id}</td>
          <td>‚ù§Ô∏è ${t.value}</td>
          <td>‚öîÔ∏è ${t.competition}</td>
          <td>üí° ${t.diff}</td>
        </tr>
      `,
          )
          .join("");
        document.getElementById("board").innerHTML = `<table class="border-collapse w-full">
          <tr><th class="border border-gray-200 px-1.5 py-1.5 text-sm align-top">Team</th><th class="border border-gray-200 px-1.5 py-1.5 text-sm align-top">Value</th><th class="border border-gray-200 px-1.5 py-1.5 text-sm align-top">Competition</th><th class="border border-gray-200 px-1.5 py-1.5 text-sm align-top">Differentiation</th></tr>
          ${rows}
        </table>`;
      }

      function renderSubs() {
        const active = new Set(STATE.activeTeams);
        const cards = STATE.teams
          .filter((t) => active.has(t.id))
          .map(
            (t) => `
        <div style="border:1px solid #eee;border-radius:12px;padding:10px;margin:8px 0" class="border border-gray-200 rounded-xl p-2.5 my-2">
          <b>${t.name} (#${t.id})</b><br/>
          <div><b>Customer:</b> ${escapeHtml(t.customer)}</div>
          <div><b>Pain:</b> ${escapeHtml(t.pain)}</div>
          <div><b>We help:</b> ${escapeHtml(t.wehelp.who)} / ${escapeHtml(t.wehelp.problem)} / ${escapeHtml(t.wehelp.by)}</div>
          <div><b>Pivot:</b> ${escapeHtml(t.pivot)}</div>
          <div><b>Blue Move:</b> ${escapeHtml(t.blueMove)}</div>
        </div>
      `,
          )
          .join("");
        document.getElementById("subs").innerHTML = cards || "‚Äî";
      }

      function escapeHtml(s) {
        return (s || "").replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#39;",
            })[m],
        );
      }
    </script>
  </body>
</html>
